# 后台开发

## 任务细则

根据用户故事，进行后台开发，8.10 把接口给前端

1. 用户系统、关系链系统、消息存储和查询

其中：

关系链是用户之间加好友、拉群等关系
消息存储是聊天消息的增删改查
就是跟用户个人信息、用户之间的关系、消息的增删改查相关的API

### 用户系统开发要求

### 用户账户

#### 注册/登录

A: 通过手机号+验证码形式进行注册、登录，若不存在用户，创建用户并登录；若存在用户，直接登录；不需要密码登录
B: 手机号一键登录：现在的“一键登录”功能会使用用户联网的手机号来直接验证，虽然费用较验证码稍高但用户体验更佳
A: 用户登录后，若未填写个人信息（头像、昵称、性别等），跳转到【个人信息修改页面】，引导用户提供个人信息

#### 修改个人信息

A: 用户首次注册之后，可以通过“我的”页面修改个人信息
A: 用户可以选择更换头像，可选择从相册中选择或直接拍照，拍照后可以截取正方形头像，由客户端压缩后上传，或者上传后服务端压缩
B: 检测头像中及其他个人信息中的敏感信息，如果有的话拒绝更新
B: 显示用户在线状态、离线时间

#### 用户鉴权

A: 客户端每次请求需在 HTTP Header 上带上 Authentication 字段作为 token；服务端以Interceptor或Advice形式，通过 token 获取用户信息；如果服务端的某个API不需要token，应该可以以某annotation类装饰；如果 token 即将过期，需下发新的token，客户端需进行更新

### 用户主页

A: 用户主页展示关注人数、所建立剧本、最近活动等信息
【最近活动】包括新建演绎、投送剧本、发布戏文等，按照时间顺序排列
A: 若用户已登录，可以选择关注其他用户
A: 已关注用户产生新动态时会推送通知

后台功能
A: 剧本管理 增 删 改 查
A: 用户管理
查看并调整用户信息
封禁用户
A: 演绎管理
A: 戏文管理
D: 文档可导出JSON格式

## 技术栈

服务端：GoLang（越快越好）

数据库：MongoDB

## 代码规范

所有代码通过 SonarLint 校验
引用超过 5 次的组件，需要配备单元测试，测试需至少覆盖所有代码行

---

## 本周分工与交付（后端-刘茂 / 懋懋）

范围：关系链、招募、消息流、戏文（Record）串联端到端流程，对接前端。

- 关系链：好友/关注/黑名单（已完成基础能力），补充越权校验（黑名单影响 DM/群/房间可见/可发）。
- 招募 Recruit：发布/列表/删除，加入演绎房间（与 Room 对接）。
- 消息 Message：统一发送与历史拉取（已完成），补充会话参与者/成员校验（已完成），接入 AI 生成消息的落库钩子（配合 @郭睿明）。
- 戏文 Record：从房间/会话选取消息生成戏文，列表/详情/消息拉取；点赞（可选）。
- 文件：头像上传改为 GridFS（已完成），提供 GET /api/file/{id} 访问。

本周目标：打通页面链路
1) 剧本详情 -> 招募发布 -> 招募详情（房间） -> 发送消息 -> 选择片段生成戏文（Record）
2) 完成鉴权、权限校验与统一返回；联调并提供种子数据与测试脚本

里程碑
- M1（今天）：鉴权与越权修复完成，文件上传改造完成，基础消息校验完成（已达成）
- M2（+1天）：Recruit 与 Room 对接（加入/发布/列表/删除），前端可进入房间并发消息
- M3（+2天）：Record 产出与列表/详情/消息接口可用，前端可展示
- M4（收尾）：黑名单与更多细粒度权限、搜索（标签/模糊）、分页联调

验收标准
- OpenAPI 文档更新并可在 IDEA 中浏览
- 端到端手动用例通过（README 中给出 curl 脚本与种子数据）
- 关键路径接口具备基础单测（鉴权、发送消息权限、Record 生成）
